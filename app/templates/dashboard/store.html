{% extends 'base.html' %}
{% block title %}Store Dashboard{% endblock %}
{% block content %}
<section class="space-y-6">
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
    <h1 class="text-2xl font-bold">{{ store.name }} Dashboard</h1>
    <p class="text-slate-300 mt-1">Company: {{ company_name }}</p>
    <p class="text-slate-400 text-sm">{{ store.platform }} | {{ store.store_url }}</p>
    <p class="text-xs text-slate-500 mt-2">Internal API Key: {{ store.internal_api_key }}</p>
    <p class="text-xs text-slate-500">Webhook Token: {{ store.internal_webhook_token }}</p>
  </div>

  <div class="grid lg:grid-cols-2 gap-6">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 space-y-5">
      <div>
        <h2 class="text-xl font-semibold mb-3">X Integration</h2>
        <form method="post" action="/stores/{{ store.id }}/connect-x" class="space-y-3">
          <input type="text" name="x_handle" placeholder="@brand_handle" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" required>
          <input type="text" name="x_bearer_token" placeholder="X Bearer Token" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" required>
          <button class="rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold px-5 py-2" type="submit">Save X Credentials</button>
        </form>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-3">Schedule X Post</h2>
        <form method="post" action="/stores/{{ store.id }}/publishing/schedule" class="space-y-3">
          <textarea name="content" rows="4" maxlength="280" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Post content (max 280 chars)" required></textarea>
          <input type="datetime-local" name="publish_at" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" required>
          <button class="rounded-lg bg-violet-500 hover:bg-violet-400 text-white font-bold px-5 py-2" type="submit">Schedule</button>
        </form>

        <form method="post" action="/stores/{{ store.id }}/publishing/run-pending" class="mt-3">
          <button class="rounded-lg border border-violet-400 text-violet-200 hover:bg-violet-500/20 px-4 py-2 text-sm" type="submit">Run Pending Now</button>
        </form>
      </div>
    </div>

    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">AI Support Test</h2>
      <form id="support-form" class="space-y-3">
        <textarea id="message" rows="4" class="w-full rounded-lg bg-slate-800 border border-slate-700 px-3 py-2" placeholder="Write customer message..."></textarea>
        <button class="rounded-lg bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold px-5 py-2" type="submit">Generate Reply</button>
      </form>
      <pre id="result" class="mt-4 p-4 rounded-lg bg-slate-950 border border-slate-800 text-sm text-cyan-300 whitespace-pre-wrap"></pre>
    </div>
  </div>

  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
    <h2 class="text-xl font-semibold mb-4">Recent Scheduled Posts ({{ store.name }})</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-slate-400 border-b border-slate-800">
            <th class="text-left py-2 pr-2">Content</th>
            <th class="text-left py-2 pr-2">Publish At</th>
            <th class="text-left py-2 pr-2">Status</th>
            <th class="text-left py-2">External ID</th>
          </tr>
        </thead>
        <tbody>
          {% for post in posts %}
          <tr class="border-b border-slate-800/70">
            <td class="py-2 pr-2">{{ post.content }}</td>
            <td class="py-2 pr-2">{{ post.publish_at }}</td>
            <td class="py-2 pr-2">{{ post.status }}</td>
            <td class="py-2">{{ post.external_post_id }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="py-3 text-slate-400">No scheduled posts yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <a href="/dashboard" class="inline-block px-4 py-2 rounded-lg border border-slate-700 hover:border-cyan-400 text-sm">‚Üê Back to company dashboard</a>
</section>

<script>
  const form = document.getElementById('support-form');
  const result = document.getElementById('result');
  const messageEl = document.getElementById('message');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    result.textContent = 'Loading AI response...';
    try {
      const response = await fetch('/api/v1/support', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ customer_id: 'store_{{ store.id }}', message: messageEl.value })
      });
      const data = await response.json();
      result.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      result.textContent = 'Request failed. Please try again.';
    }
  });
</script>
{% endblock %}
